---
layout: post
title: '乔布斯与贝索斯-------公司产品监控子系统监控模块重构'
date: 2014-05-21 14:12
comments: true
categories: [bezos, jobs, 设计, 乔布斯, 贝索斯, 干货]
---
#旅游
---------------------------------------
终于差不多可以休息个半个月去旅游下了。作为旅游前的最后一遍博文，就把这周的工作作为主体阐述下，也把最近看的书的一点感悟阐述下。

#乔布斯与贝索斯
---------------------------------------
最近看一网打尽，发现乔布斯和贝索斯还真是很像。虽然，他们人性中都有很多让正常人不好沟通交流的地方，让他们的员工都很怕和他们一起坐电梯，但是，他们的感染力、创新力、决策力、行动力，还是让我们尊称他们为神。
首先，他们有产品经理应该有的嗅觉，可以说，乔布斯80年代就已经预测到了二十一世纪的电脑使用方式了，只是他太超前了，当时的主流用户根本没法接受；而贝索斯虽然也有很多失误，但是他大方向上都是没错的，一键下单、推荐引擎、Kindle阅读器等，都是划时代的产品。可以说，乔布斯重定义了电脑和手机，贝索斯重定义了书；
然后，他们都具有非常强的现实扭曲力，乔布斯可以告诉你，电脑就是应该这么操作的，手机就应该像我这么用。他觉得你不该有的东西，就不能有。不像安卓手机，尽可能的满足用户的各种需求，最后导致定制化太多，整个安卓平台都是碎片化的。一个好的产品，只需要满足80%主流用户的80%主要需求即可。而贝索斯，他改变了人们不止实现了世界上最大的书店，慢慢的发展成最大的电商平台，最大的综合服务公司，他不断的创新，不断的让你接受他的创新；
还有，他们都有很强的决策力和行动力，他们不但能清晰的看到机会，还能将想法很快的付出于行动。他们都崇尚于行动；
另外，他们都被董事会提议解雇，最后乔布斯确实被一个来自可口可乐的卖糖水的人赶走了，而贝索斯也差点被一个来自百事可乐卖糖水的赶走，还好贝索斯的感染力比乔布斯好，很多手下还是被他感（xi）染（nao）了，成为了Jeff Reboot；
最后，他们都对自己的技术合伙人很冷酷。乔布斯又沃兹，贝索斯有卡芬，这两个奇才除了技术都很牛意外，他们还有个同样的特点，内向，木讷。卡芬至少还争取了，沃兹就显得无所谓了，任由乔布斯一点一点的把他边缘化，最后他也就去做遥控器开发了，不过，挺成功的。**对于乔布斯和贝索斯，在他们的字典里面，没有合作这个词，只有为他们所用**。

他们的名言：
1. Stay hungry stay foolish.
2. We are our choice.

#监控模块重构
----------------------------------------
##原问题
原来监控模块的逻辑有两个问题

1. 原来的TMtObjItem与TMtObj的对应关系是固定的，比如原有4个监控项，那么就是4：1，就是说，比如一个监控对象是服务器，那么就有4个监测项（连通性、CPU、内存、磁盘）。那么就存在一个问题，如果有两个监控方案对应同一个监控对象，那么他们就存在同步的问题。比如监控方案A修改了CPU使用率的监测阀值，那么监控方案B就必须和A一样，如果B再设置了，就又会把A覆盖了；
2. 按原有的设计，注册监控对象的时候，就一定要创建监控项，因为他与方案是无关的，且还要建立与现有的类型监控方案的关系；
3. 按原有设计，监控项日志记录与监控项绑定，那么，就无法判断每次监测对象的时候是监测了几个对象。

##重构设计UML
![](http://i1.tietuku.com/86a31da4f94810e3s.jpg)
##依赖关系调整
###监控数据结构关系调整
去除了原数据结构TMtObjItem，TMTObjNorm，TMtObjThreadhol等对象，取而代之的是TMTSchemeItem、TMtShcemeObj，并且与方案1对n关联，TMtObj对象并不直接持有，但是TMtSchemeObj持有TMtObj作为MetaObj。
###监控日志关系调整
让监测对象日志与调度方案日志绑定，这样做数据分析统计的时候，就可以根据查找相应对象最近调度方案来找到最近一次监控的结果，就算只监控了其中几个监测项，也可以发现。
##溯源方式调整
在SerialMonitor中，会通过判断方案的类型，如果是类型监测方案就会向上追溯，比如监控数据库，有异常就会去监测是否是服务器存在异常。如果是组合监控方案，就会根据组合监控对象的组合结构，去往下追溯异常源头。
##构造方式
原类型监测方案创建时候会去创建TMtObjItem，当创建监控对象的时候还要将新创建的监控对象添加到相应的类型监测方案下。现在只是运行监测方案的时候，会去构造TMtSchemeObj和TMtSchemeItem。
##监控结果记录方式
原来的监控结果基本记录在TMtLogObjItem中。现在另外还记在TMtSchemeItem中，方便追溯。
##调用方式
SerialMonitor的monitor方法为入口方法，可以争对不同的实现子类实现多态。而其基类的monitorOneItem方法为抽象的逻辑，对溯源、监控、记录日志、监控监控项状态等行为进行了调用。这些行为依赖于相应的接口，这些接口可以有不同的子类实现，通过策略模式与模板模式实现了具体监控的多态。
##重构中发现的问题
代码的重构可以用单元测试来防止错误，那么，现有很多数据都是通过存储过程来分析统计的。对于存储过程这块没有相应的单元测试方法，为了验证重构有没有带来影响，我只能辛苦的造数据，而且测试完以后觉得还是存在隐患，因为覆盖度根本不够。
或许有人会说，那么就不用存储过程，吧分析统计写到java里面，将控制权把握在手上呗。但是，这要看场景。因为我们的业务线比较长，甚至到了新疆内蒙等地方，如果把分析统计这种会根据实际需要变的业务逻辑写到程序中，那么必定导致开发人员的维护工作大大增加，有的时候不得不出差到现场去解决问题。那么，如果用存储过程，我只要定义好需要的数据，存储过程怎么去统计和分析，都是现场的运维人员可控的。